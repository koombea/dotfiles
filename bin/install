#!/bin/bash

set -e

dir=$PWD
if [[ ! "$dir/bin/install" -ef "$0" ]]; then
  echo "Please run 'bin/install' from dotfiles root folder"
  exit 1
fi
# Getting dotfiles list into an array
files=( $(find . -maxdepth 1 -name '.*' -type f | sed 's#^\./##') )

# Sysmlink dotfiles to HOME directory and renaming existing file with .old suffix
for file in ${files[@]}; do
  printf "${file}\t"
  dotfile_path="${dir}/${file}"
  path="${HOME}/${file}"
  # If file exists and it's a symlink
  if [ -L $path ]; then
    printf "Skipped. It already exists\n"
  else
    # If file exists
    if [ -f $path ]; then
      mv $path "${path}.old"
      printf "(Renaming ${file} to ${file}.old)\t"
    fi
    ln -nfs $dotfile_path $path
    printf "Symlinked to ${path}\n"
  fi
done

#Checking the presence of .local files in HOME directory and generate them if don't exist
localfiles=".tmux.conf.local .vimrc.local"
for file in $localfiles; do
  foundfile=($(find $HOME -maxdepth 1 -name "$file" -type f) )
  # Return true if the variable is unset
  if [ -z "$foundfile" ]; then
    touch "${HOME}/${file}"
    echo "Generating $file"
  fi
done

